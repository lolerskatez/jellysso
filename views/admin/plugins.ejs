<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Plugin Management - Jellyfin Companion Admin">
  <meta name="csrf-token" content="<%= csrfToken || '' %>">
  <title>Plugin Management - Jellyfin Companion</title>
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/fontawesome.css">
  <style>
    .plugin-container {
      max-width: 1000px;
    }

    .info-card {
      background: linear-gradient(135deg, #f0e7ff 0%, #f5f3ff 100%);
      border: 1px solid #d8c9f0;
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .info-card h3 {
      color: #5b21b6;
      margin: 0 0 var(--spacing-md) 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .info-card p {
      color: #6b21a8;
      margin: 0;
      font-size: 0.9375rem;
    }

    .uri-display {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .uri-display h3 {
      margin: 0 0 var(--spacing-lg) 0;
      font-size: 1.125rem;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .uri-display h3 i {
      color: var(--primary);
    }

    .uri-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-md);
    }

    .uri-item:last-child {
      margin-bottom: 0;
    }

    .uri-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .uri-value {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      background: var(--bg-secondary);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      color: var(--text-primary);
      word-break: break-all;
    }

    .uri-value button {
      flex-shrink: 0;
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      padding: var(--spacing-xs);
      border-radius: var(--border-radius);
      transition: all var(--transition);
    }

    .uri-value button:hover {
      background: var(--primary-lighter);
    }

    .btn-sm {
      padding: 4px 12px;
      font-size: 0.8125rem;
      border-radius: var(--border-radius);
    }

    .status-section {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-xl);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-xl);
    }

    .status-section h3 {
      margin: 0 0 var(--spacing-lg) 0;
      font-size: 1.125rem;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--border-color);
    }

    .status-section h3 i {
      color: var(--primary);
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-lg);
    }

    .status-item {
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
    }

    .status-item label {
      display: block;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      margin-bottom: var(--spacing-xs);
      text-transform: uppercase;
    }

    .status-value {
      font-size: 1.125rem;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: 20px;
      font-size: 0.8125rem;
      font-weight: 600;
    }

    .status-badge.installed {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status-badge.not-installed {
      background: rgba(107, 114, 128, 0.1);
      color: var(--gray-500);
    }

    .settings-card {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-xl);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-xl);
    }

    .settings-card h3 {
      margin: 0 0 var(--spacing-lg) 0;
      font-size: 1.125rem;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--border-color);
    }

    .settings-card h3 i {
      color: var(--primary);
    }

    .tab-container {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      border-bottom: 2px solid var(--border-color);
    }

    .tab-button {
      padding: var(--spacing-md) var(--spacing-lg);
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all var(--transition);
    }

    .tab-button:hover {
      color: var(--primary);
    }

    .tab-button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--gray-900);
    }

    .form-label .required {
      color: var(--danger);
    }

    .form-hint {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-top: var(--spacing-xs);
    }

    .form-input {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 0.9375rem;
      transition: all var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .form-input[type="password"] {
      font-family: 'Courier New', monospace;
    }

    .password-toggle {
      position: relative;
    }

    .password-toggle-btn {
      position: absolute;
      right: var(--spacing-md);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    .password-toggle-btn:hover {
      color: var(--primary);
    }

    .toggle-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-md);
    }

    .toggle-label {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .toggle-label strong {
      color: var(--gray-900);
    }

    .toggle-label span {
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--gray-300);
      transition: 0.3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--success);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    .button-group {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .logs-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      max-height: 400px;
      overflow-y: auto;
      color: var(--text-primary);
    }

    .logs-empty {
      color: var(--text-secondary);
      font-style: italic;
      text-align: center;
      padding: var(--spacing-xl);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--border-radius);
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.info {
      background: var(--primary);
    }

    @media (max-width: 768px) {
      .status-grid {
        grid-template-columns: 1fr;
      }

      .tab-container {
        flex-wrap: wrap;
      }

      .button-group {
        flex-direction: column;
      }

      .button-group .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <%- include('../partials/navigation', { user, currentPage: 'admin-plugins' }) %>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="header-title">Plugin Management</h1>
        </div>
        <div class="header-right">
          <span class="status-badge" id="pluginStatus">
            <i class="fas fa-circle"></i>
            <span>Loading...</span>
          </span>
        </div>
      </header>

      <div class="page-content">
        <div class="plugin-container">
          <!-- Notification -->
          <div id="notification" class="notification"></div>

          <!-- Info Card -->
          <div class="info-card">
            <h3><i class="fas fa-info-circle"></i> About Plugins</h3>
            <p>
              Manage Jellyfin Companion plugins and extensions. The SSO plugin provides
              Single Sign-On integration with your identity provider, allowing seamless
              authentication across your Jellyfin instance.
            </p>
          </div>

          <!-- Plugin Configuration Information -->
          <div class="uri-display" style="background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); border: 1px solid #7dd3fc;">
            <h3><i class="fas fa-cog"></i> Jellyfin Plugin Configuration</h3>
            <p style="margin-bottom: var(--spacing-lg); color: #0c4a6e; font-size: 0.875rem;">
              After installing the plugin in Jellyfin, configure it with these values:
            </p>
            
            <div class="uri-item">
              <span class="uri-label">Companion Base URL</span>
              <div class="uri-value">
                <span id="companionBaseUrl"><%= baseUrl %></span>
                <button type="button" onclick="copyToClipboard('companionBaseUrl')" title="Copy to clipboard">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>

            <div class="uri-item">
              <span class="uri-label">Shared Secret / API Key</span>
              <div class="uri-value">
                <span id="sharedSecretDisplay">••••••••••••••••</span>
                <button type="button" id="toggleSecretBtn" title="Show/Hide Secret">
                  <i class="fas fa-eye"></i>
                </button>
                <button type="button" onclick="copyToClipboard('sharedSecretValue')" title="Copy to clipboard">
                  <i class="fas fa-copy"></i>
                </button>
                <button type="button" id="generateSecretBtn" class="btn-sm btn-secondary" style="margin-left: var(--spacing-sm);">
                  <i class="fas fa-sync"></i> Generate New
                </button>
              </div>
              <span id="sharedSecretValue" style="display: none;"></span>
            </div>

            <div class="uri-item">
              <span class="uri-label">Validation Endpoint</span>
              <div class="uri-value">
                <span id="validationEndpoint"><%= baseUrl %>/api/auth/validate-sso</span>
                <button type="button" onclick="copyToClipboard('validationEndpoint')" title="Copy to clipboard">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Plugin Status -->
          <div class="status-section">
            <h3><i class="fas fa-puzzle-piece"></i> Plugin Status</h3>
            <div class="status-grid">
              <div class="status-item">
                <label>SSO Plugin</label>
                <div class="status-value">
                  <span id="ssoPluginStatus" class="status-badge not-installed">
                    <i class="fas fa-times-circle"></i>
                    Not Installed
                  </span>
                </div>
              </div>
              <div class="status-item">
                <label>Available Version</label>
                <div class="status-value" id="pluginVersion">1.0.0</div>
              </div>
              <div class="status-item">
                <label>Last Updated</label>
                <div class="status-value" id="pluginUpdated">--</div>
              </div>
            </div>
            <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color);">
              <button type="button" class="btn btn-secondary" id="downloadPluginBtn">
                <i class="fas fa-download"></i> Download Plugin (DLL)
              </button>
              <p style="margin-top: var(--spacing-sm); font-size: 0.8125rem; color: var(--text-secondary);">
                Download the Jellyfin SSO plugin DLL file for installation on your Jellyfin server.
              </p>
            </div>
          </div>

          <!-- Plugin Configuration -->
          <div class="settings-card">
            <h3><i class="fas fa-cog"></i> Configuration</h3>

            <!-- Tab Navigation -->
            <div class="tab-container">
              <button type="button" class="tab-button active" data-tab="settings">
                <i class="fas fa-sliders-h"></i> Settings
              </button>
              <button type="button" class="tab-button" data-tab="logs">
                <i class="fas fa-file-alt"></i> Logs
              </button>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content active" id="tab-settings">
              <form id="pluginForm">
                <div class="toggle-group">
                  <div class="toggle-label">
                    <strong>Enable SSO Plugin</strong>
                    <span>Activate Single Sign-On functionality</span>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="pluginEnabled" name="enabled">
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    Companion App URL <span class="required">*</span>
                  </label>
                  <input type="url" class="form-input" id="appUrl" name="appUrl"
                         placeholder="https://companion.example.com"
                         data-config-key="appUrl">
                  <p class="form-hint">The base URL of the Jellyfin Companion application</p>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    API Key <span class="required">*</span>
                  </label>
                  <div class="password-toggle">
                    <input type="password" class="form-input" id="apiKey" name="apiKey"
                           placeholder="Enter API key"
                           data-config-key="apiKey">
                    <button type="button" class="password-toggle-btn" data-target="apiKey">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                  <p class="form-hint">The API key for authenticating with the Companion app</p>
                </div>

                <div class="toggle-group">
                  <div class="toggle-label">
                    <strong>Validate Sessions</strong>
                    <span>Require token validation with Companion app</span>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="validateSessions" name="validateSessions" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="form-group">
                  <label class="form-label">Session Timeout (seconds)</label>
                  <input type="number" class="form-input" id="sessionTimeout" name="sessionTimeout"
                         value="3600" min="300"
                         data-config-key="sessionTimeout">
                  <p class="form-hint">How long sessions remain valid (minimum 5 minutes)</p>
                </div>

                <div class="button-group">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Configuration
                  </button>
                  <button type="button" class="btn btn-secondary" id="testConnectionBtn">
                    <i class="fas fa-plug"></i> Test Connection
                  </button>
                </div>
              </form>
            </div>

            <!-- Logs Tab -->
            <div class="tab-content" id="tab-logs">
              <div class="form-group">
                <label class="form-label">SSO Validation Logs</label>
                <div class="logs-container" id="logsContainer">
                  <div class="logs-empty">No logs available</div>
                </div>
                <button type="button" class="btn btn-secondary" id="clearLogsBtn" style="margin-top: var(--spacing-lg);">
                  <i class="fas fa-trash"></i> Clear Logs
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <div class="plugin-config" 
       id="pluginConfig"
       data-plugin-config="<%= JSON.stringify({ baseUrl: baseUrl, csrfToken: csrfToken || '' }) %>">
  </div>

  <script src="/js/mobile-nav.js"></script>
  <script src="/js/admin-plugins.js?v=3"></script>
</body>
</html>
