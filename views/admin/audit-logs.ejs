<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Audit Logs - Jellyfin Companion Admin">
  <title>Audit Logs - Jellyfin Companion</title>
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/fontawesome.css">
  <style>
    /* Filter Bar */
    .filter-bar {
      background: white;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-lg);
    }
    .filter-form {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      align-items: flex-end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    .filter-group label {
      font-weight: 600;
      font-size: 0.8125rem;
      color: var(--gray-900);
    }
    .filter-group input,
    .filter-group select {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 0.9375rem;
      min-width: 150px;
    }
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }
    .filter-actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-left: auto;
    }

    /* Stats Summary */
    .stats-summary {
      display: flex;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-lg);
      background: white;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
    }
    .stat-item i {
      font-size: 1.25rem;
    }
    .stat-item.total i { color: var(--primary); }
    .stat-item.success i { color: var(--success); }
    .stat-item.failure i { color: var(--danger); }
    .stat-item strong {
      font-size: 1.25rem;
      color: var(--gray-900);
    }
    .stat-item span {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Audit Table */
    .table-container {
      background: white;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    .audit-table {
      width: 100%;
      border-collapse: collapse;
    }
    .audit-table th {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      text-align: left;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-900);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-color);
    }
    .audit-table td {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9375rem;
      vertical-align: middle;
    }
    .audit-table tr:last-child td {
      border-bottom: none;
    }
    .audit-table tr:hover {
      background: var(--bg-secondary);
    }
    .audit-table code {
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8125rem;
      font-family: monospace;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    .status-failure {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    /* Action Badge */
    .action-badge {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary);
      border-radius: var(--border-radius);
      font-size: 0.75rem;
      font-weight: 600;
      font-family: monospace;
    }

    /* Pagination */
    .pagination {
      display: flex;
      gap: var(--spacing-xs);
      justify-content: center;
      padding: var(--spacing-lg);
    }
    .pagination a,
    .pagination span {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      text-decoration: none;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: all var(--transition);
    }
    .pagination a:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .pagination .active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* No Data */
    .no-data {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.3s;
    }
    .modal-overlay.active .modal {
      transform: scale(1);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
    }
    .modal-header h3 {
      margin: 0;
      font-size: 1.125rem;
      color: var(--gray-900);
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .modal-body {
      padding: var(--spacing-lg);
      max-height: 60vh;
      overflow: auto;
    }
    .modal-body pre {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      font-size: 0.8125rem;
      overflow-x: auto;
      margin: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filter-form {
        flex-direction: column;
      }
      .filter-group {
        width: 100%;
      }
      .filter-group input,
      .filter-group select {
        width: 100%;
      }
      .stats-summary {
        flex-wrap: wrap;
      }
      .audit-table {
        font-size: 0.8125rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <%- include('../partials/navigation', { user, currentPage: 'admin-audit-logs' }) %>
    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="header-title">Audit Logs
          </h1>
        </div>
        <div class="header-right">
          <button class="btn btn-secondary btn-sm" id="exportLogsBtn">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </header>

      <div class="page-content">
        <!-- Stats Summary -->
        <div class="stats-summary">
          <div class="stat-item total">
            <i class="fas fa-list"></i>
            <strong><%= totalLogs %></strong>
            <span>Total Entries</span>
          </div>
          <div class="stat-item success">
            <i class="fas fa-check-circle"></i>
            <strong><%= typeof successCount !== 'undefined' ? successCount : '-' %></strong>
            <span>Successful</span>
          </div>
          <div class="stat-item failure">
            <i class="fas fa-times-circle"></i>
            <strong><%= typeof failureCount !== 'undefined' ? failureCount : '-' %></strong>
            <span>Failed</span>
          </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
          <form method="GET" class="filter-form">
            <div class="filter-group">
              <label>Action</label>
              <input type="text" name="action" placeholder="e.g., LOGIN_FAILED" value="<%= filters.action || '' %>">
            </div>
            <div class="filter-group">
              <label>User</label>
              <input type="text" name="userId" placeholder="Username" value="<%= filters.userId || '' %>">
            </div>
            <div class="filter-group">
              <label>Status</label>
              <select name="status">
                <option value="">All</option>
                <option value="success" <%= filters.status === 'success' ? 'selected' : '' %>>Success</option>
                <option value="failure" <%= filters.status === 'failure' ? 'selected' : '' %>>Failure</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Per Page</label>
              <select name="limit">
                <option value="25" <%= filters.limit === '25' || !filters.limit ? 'selected' : '' %>>25</option>
                <option value="50" <%= filters.limit === '50' ? 'selected' : '' %>>50</option>
                <option value="100" <%= filters.limit === '100' ? 'selected' : '' %>>100</option>
              </select>
            </div>
            <div class="filter-actions">
              <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-filter"></i> Filter
              </button>
              <a href="/admin/audit-logs" class="btn btn-secondary btn-sm">
                <i class="fas fa-undo"></i> Reset
              </a>
            </div>
          </form>
        </div>

        <!-- Audit Table -->
        <div class="table-container">
          <table class="audit-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Action</th>
                <th>User</th>
                <th>Resource</th>
                <th>Status</th>
                <th>IP Address</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              <% if (logs && logs.length > 0) { %>
                <% logs.forEach(log => { %>
                  <tr>
                    <td>
                      <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                        <%= new Date(log.timestamp).toLocaleDateString() %>
                      </div>
                      <div style="font-size: 0.75rem; color: var(--gray-400);">
                        <%= new Date(log.timestamp).toLocaleTimeString() %>
                      </div>
                    </td>
                    <td>
                      <span class="action-badge"><%= log.action %></span>
                    </td>
                    <td><strong><%= log.username || log.userId || 'System' %></strong></td>
                    <td>
                      <code><%= log.resource || '-' %></code>
                    </td>
                    <td>
                      <span class="status-badge status-<%= log.status === 'success' ? 'success' : 'failure' %>">
                        <i class="fas fa-<%= log.status === 'success' ? 'check' : 'times' %>"></i>
                        <%= log.status %>
                      </span>
                    </td>
                    <td style="font-family: monospace; font-size: 0.8125rem;"><%= log.ip || 'N/A' %></td>
                    <td>
                      <% if (log.details && Object.keys(log.details).length > 0) { %>
                        <button class="btn btn-secondary btn-sm" data-action="view-details" data-details="<%= JSON.stringify(log.details).replace(/"/g, '&quot;') %>">
                          <i class="fas fa-eye"></i>
                        </button>
                      <% } else { %>
                        <span style="color: var(--text-secondary);">-</span>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="7" class="no-data">
                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: var(--spacing-md); display: block;"></i>
                    No logs found matching the filters
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>

          <% if (pages > 1) { %>
            <div class="pagination">
              <% if (currentPage > 1) { %>
                <a href="?page=1&action=<%= filters.action || '' %>&userId=<%= filters.userId || '' %>&status=<%= filters.status || '' %>&limit=<%= filters.limit || '25' %>">
                  <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?page=<%= currentPage - 1 %>&action=<%= filters.action || '' %>&userId=<%= filters.userId || '' %>&status=<%= filters.status || '' %>&limit=<%= filters.limit || '25' %>">
                  <i class="fas fa-angle-left"></i>
                </a>
              <% } %>
              
              <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(pages, currentPage + 2); i++) { %>
                <% if (i === currentPage) { %>
                  <span class="active"><%= i %></span>
                <% } else { %>
                  <a href="?page=<%= i %>&action=<%= filters.action || '' %>&userId=<%= filters.userId || '' %>&status=<%= filters.status || '' %>&limit=<%= filters.limit || '25' %>"><%= i %></a>
                <% } %>
              <% } %>
              
              <% if (currentPage < pages) { %>
                <a href="?page=<%= currentPage + 1 %>&action=<%= filters.action || '' %>&userId=<%= filters.userId || '' %>&status=<%= filters.status || '' %>&limit=<%= filters.limit || '25' %>">
                  <i class="fas fa-angle-right"></i>
                </a>
                <a href="?page=<%= pages %>&action=<%= filters.action || '' %>&userId=<%= filters.userId || '' %>&status=<%= filters.status || '' %>&limit=<%= filters.limit || '25' %>">
                  <i class="fas fa-angle-double-right"></i>
                </a>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </main>
  </div>

  <!-- Details Modal -->
  <div class="modal-overlay" id="detailsModal">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-info-circle"></i> Log Details</h3>
        <button class="modal-close" id="closeDetailsModal">&times;</button>
      </div>
      <div class="modal-body">
        <pre id="modalDetailsContent"></pre>
      </div>
    </div>
  </div>

  <script src="/js/mobile-nav.js"></script>
  <script src="/js/admin-audit-logs.js"></script>
  <script src="/js/admin-dashboard.js"></script>
</body>
</html>
